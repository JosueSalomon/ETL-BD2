CREATE OR REPLACE PROCEDURE ETL_COPIAS_DE_SEGURIDAD AS
    V_FECHA_INICIO DATE;
    V_FECHA_FIN DATE := TRUNC(SYSDATE); -- Fecha actual
    V_HORA_INICIO_PROCESO DATE := SYSDATE;
BEGIN

    EXECUTE IMMEDIATE 'TRUNCATE TABLE C##DWH.TBL_COPIAS_DE_SEGURIDAD';
    
    SELECT MIN(FECHA_MODIFICACION) INTO V_FECHA_INICIO FROM TBL_COPIAS_DE_SEGURIDAD;

    IF V_FECHA_INICIO IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('No hay datos para procesar.');
        RETURN;
    END IF;

    WHILE V_FECHA_INICIO <= V_FECHA_FIN LOOP

    DELETE FROM C##DWH.TBL_COPIAS_DE_SEGURIDAD
    WHERE TRUNC(FECHA_MODIFICACION) = TRUNC(V_FECHA_INICIO);
    
    INSERT INTO C##DWH.TBL_COPIAS_DE_SEGURIDAD(
        ID_COPIA_DE_SEGURIDAD,
        NOMBRE,
        ORGIEN,
        FECHA_MODIFICACION,
        ID_USAURIO
    )
    SELECT ID_COPIA_DE_SEGURIDAD,
        NOMBRE,
        ORIGEN,
        FECHA_MODIFICACION,
        ID_USUARIO
    FROM TBL_COPIAS_DE_SEGURIDAD
    WHERE TRUNC(FECHA_MODIFICACION) = TRUNC(V_FECHA_INICIO);
    
    COMMIT;

        V_FECHA_INICIO := V_FECHA_INICIO + 1;
    END LOOP;
      P_ETL_LOG(
        P_NOMBRE_ETL => $$PLSQL_UNIT,
        P_FECHA_HORA_INICIO => sysdate,
        P_ESTATUS => 'S',
        P_ERROR => ''
    );
    -- Hacer commit para confirmar los cambios en la base de datos
    COMMIT;
    EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('No se encontraron datos.');
        -- Agregar al log de errores
        P_ETL_LOG(
            P_NOMBRE_ETL => $$PLSQL_UNIT,
            P_FECHA_HORA_INICIO => sysdate,
            P_ESTATUS => 'F',
            P_ERROR => SQLCODE || ' - ' || SQLERRM
        );
END ETL_COPIAS_DE_SEGURIDAD;

BEGIN
    ETL_COPIAS_DE_SEGURIDAD;
END;

--JOB ETL_ACTIVIDADES_USUARIOS
BEGIN
    DBMS_SCHEDULER.CREATE_SCHEDULE (
        SCHEDULE_NAME => 'INTERVALO_DIARIO',
        START_DATE => TRUNC(SYSDATE),
        REPEAT_INTERVAL => 'FREQ=DAILY; INTERVAL=1',
        COMMENTS => 'EJECUCIÃ“N DIARIA'
    );
END;
/
BEGIN
    DBMS_SCHEDULER.CREATE_PROGRAM(
        PROGRAM_NAME => 'PR_ETL_COPIAS_DE_SEGURIDAD',
        PROGRAM_TYPE => 'PLSQL_BLOCK',
        PROGRAM_ACTION => 'BEGIN ETL_COPIAS_DE_SEGURIDAD; END;',
        ENABLED => TRUE,
        COMMENTS => 'EJECUCION PROGRAMA ETL_COPIAS_DE_SEGURIDAD'
    );
END;

BEGIN
    DBMS_SCHEDULER.CREATE_JOB (
        JOB_NAME => 'JOB_ETL_COPIAS_DE_SEGURIDAD',
        PROGRAM_NAME => 'PR_ETL_COPIAS_DE_SEGURIDAD',
        SCHEDULE_NAME => 'INTERVALO_DIARIO',
        ENABLED => TRUE,
        AUTO_DROP => FALSE,
        COMMENTS => 'EJECUCION DEL JOB ETL_COPIAS_DE_SEGURIDAD'
    );
END;


