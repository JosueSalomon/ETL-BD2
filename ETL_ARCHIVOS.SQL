CREATE OR REPLACE PROCEDURE ETL_ARCHIVOS AS
    V_FECHA_INICIO DATE;
    V_FECHA_FIN DATE := TRUNC(SYSDATE); -- Fecha actual
    V_HORA_INICIO_PROCESO DATE := SYSDATE;
BEGIN
    EXECUTE IMMEDIATE 'TRUNCATE TABLE C##DWH.TBL_ARCHIVOS';
    
    SELECT MIN(A.FECHA_CREACION) INTO V_FECHA_INICIO FROM TBL_ARCHIVOS A;

    IF V_FECHA_INICIO IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('No hay datos para procesar.');
        RETURN;
    END IF;
    
    WHILE V_FECHA_INICIO <= V_FECHA_FIN LOOP
    
        DELETE FROM C##DWH.TBL_ARCHIVOS
        WHERE TRUNC(FECHA_CREACION) = TRUNC(V_FECHA_INICIO);
        
        INSERT INTO C##DWH.TBL_ARCHIVOS(
            ID_ARCHIVO,
            ID_USAURIO_DUENO,
            ID_UBICACION,
            TAMANO,
            NOMBRE,
            FECHA_CREACION,
            FECHA_ABIERTO,
            ESTADO,
            TIPO_ARCHIVO,
        )
        SELECT A.ID_ARCHIVO, A.ID_PROPIETARIO, B.ID_UBICACION, A.TAMANO, A.NOMBRE,
            A.FECHA_CREACION, A.FECHA_ABIERTO, C.TIPO_ESTADO, D.TIPO_ARCHIVO,
            E.ETIQUETA, F.NUMERO_VERSION
        FROM TBL_ARCHIVOS A
        INNER JOIN TBL_UBICACIONES_ARCHIVOS B ON (A.UBICACION = B.ID_UBICACION)
        INNER JOIN TBL_ESTADOS_ARCHIVO C ON (A.ESTADO = C.ID_ESTADO)
        INNER JOIN TBL_TIPOS_ARCHIVOS D ON (A.TIPO_ARCHIVO = D.ID_TIPO_ARCHIVO)
        INNER JOIN TBL_ETIQUETAS_ARCHIVOS E ON (A.ID_ARCHIVO = E.ID_ARCHIVO)
        INNER JOIN TBL_VERSIONES_ARCHIVOS F ON (A.ID_ARCHIVO = F.ID_ARCHIVO)
        WHERE TRUNC(A.FECHA_CREACION) = TRUNC(V_FECHA_INICIO);
        
        COMMIT;
        V_FECHA_INICIO := V_FECHA_INICIO + 1;
    END LOOP;
END;
/

begin
    ETL_ARCHIVOS;
end;

select *
